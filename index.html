-- ============================================================
-- Run this in Supabase SQL Editor
-- Only the NEW tables needed for ordering & menu management
-- ============================================================

-- MENU ITEMS TABLE
CREATE TABLE IF NOT EXISTS menu_items (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  category TEXT DEFAULT 'Drinks',
  description TEXT,
  base_price NUMERIC(6,2) DEFAULT 0,
  sizes JSONB DEFAULT '["Small", "Medium", "Large"]',
  available_syrups TEXT[] DEFAULT ARRAY['Vanilla', 'Caramel', 'Hazelnut', 'Sugar Free Vanilla'],
  available_milks TEXT[] DEFAULT ARRAY['Whole Milk', 'Oat Milk', 'Almond Milk', '2% Milk'],
  square_link TEXT,
  available BOOLEAN DEFAULT true,
  sort_order INT DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- STORE CONFIG TABLE
CREATE TABLE IF NOT EXISTS store_config (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  key TEXT UNIQUE NOT NULL,
  value JSONB NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Enable RLS
ALTER TABLE menu_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE store_config ENABLE ROW LEVEL SECURITY;

-- Menu policies
CREATE POLICY "Authenticated users can read menu" ON menu_items
  FOR SELECT USING (auth.role() = 'authenticated');

CREATE POLICY "Admins can manage menu" ON menu_items
  FOR ALL USING (
    (auth.jwt() -> 'user_metadata' ->> 'role') = 'admin'
  );

-- Config policies
CREATE POLICY "Authenticated users can read config" ON store_config
  FOR SELECT USING (auth.role() = 'authenticated');

CREATE POLICY "Admins can manage config" ON store_config
  FOR ALL USING (
    (auth.jwt() -> 'user_metadata' ->> 'role') = 'admin'
  );

-- Add new columns to orders table if not already there
ALTER TABLE orders ADD COLUMN IF NOT EXISTS size TEXT;
ALTER TABLE orders ADD COLUMN IF NOT EXISTS milk TEXT;
ALTER TABLE orders ADD COLUMN IF NOT EXISTS syrup TEXT;
ALTER TABLE orders ADD COLUMN IF NOT EXISTS delivery_time TEXT;
ALTER TABLE orders ADD COLUMN IF NOT EXISTS delivery_day TEXT;
ALTER TABLE orders ADD COLUMN IF NOT EXISTS special_instructions TEXT;

-- Default delivery times
INSERT INTO store_config (key, value) VALUES
  ('delivery_times', '["7:30 AM", "8:00 AM", "8:30 AM", "9:00 AM", "10:00 AM", "11:00 AM", "12:00 PM"]')
ON CONFLICT (key) DO NOTHING;

-- Sample menu items
INSERT INTO menu_items (name, category, description, sort_order) VALUES
  ('Latte', 'Coffee', 'Espresso with steamed milk', 1),
  ('Cappuccino', 'Coffee', 'Espresso with foam', 2),
  ('Mocha', 'Coffee', 'Espresso with chocolate and steamed milk', 3),
  ('Americano', 'Coffee', 'Espresso with hot water', 4),
  ('Hot Chocolate', 'Non-Coffee', 'Rich steamed chocolate drink', 5),
  ('Chai Latte', 'Non-Coffee', 'Spiced chai with steamed milk', 6),
  ('Iced Coffee', 'Iced', 'Cold brew over ice', 7),
  ('Iced Latte', 'Iced', 'Espresso with cold milk over ice', 8)
ON CONFLICT DO NOTHING;
