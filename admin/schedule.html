<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>The Birdhouse ‚Äî Schedule Builder</title>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{--black:#0a0a0a;--red:#cc0000;--red-bright:#ff1a1a;--gray:#555;--light-gray:#999;--white:#f0f0f0;--card:#141414;--border:rgba(204,0,0,0.18);--border-dim:rgba(255,255,255,0.07)}
    body{background:var(--black);color:var(--white);font-family:'DM Sans',sans-serif;min-height:100vh}
    body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(204,0,0,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(204,0,0,0.03) 1px,transparent 1px);background-size:40px 40px;pointer-events:none}
    .layout{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
    .sidebar{background:#0d0000;border-right:1px solid var(--border);padding:1.75rem 1.25rem;position:sticky;top:0;height:100vh;display:flex;flex-direction:column;overflow-y:auto}
    .sidebar img{height:40px;filter:drop-shadow(0 0 10px rgba(204,0,0,0.6));margin-bottom:0.75rem}
    .admin-badge{background:rgba(204,0,0,0.15);border:1px solid var(--border);border-radius:6px;padding:0.3rem 0.75rem;font-size:0.62rem;text-transform:uppercase;letter-spacing:0.14em;color:var(--red-bright);margin-bottom:2rem;display:inline-block}
    .nav-section{font-size:0.58rem;text-transform:uppercase;letter-spacing:0.16em;color:var(--gray);margin:1.1rem 0 0.4rem 0.9rem}
    .nav-item{display:flex;align-items:center;gap:0.7rem;padding:0.7rem 0.9rem;border-radius:7px;color:var(--gray);font-size:0.85rem;cursor:pointer;transition:all 0.2s;margin-bottom:0.2rem;border:1px solid transparent;text-decoration:none}
    .nav-item:hover{color:var(--white);background:rgba(255,255,255,0.04)}
    .nav-item.active{background:rgba(204,0,0,0.12);color:var(--red-bright);border-color:rgba(204,0,0,0.25)}
    .signout-btn{background:none;border:1px solid rgba(255,255,255,0.08);border-radius:7px;padding:0.65rem 1rem;color:var(--gray);font-size:0.8rem;cursor:pointer;width:100%;text-align:left;transition:all 0.2s;display:flex;align-items:center;gap:0.5rem;font-family:'DM Sans',sans-serif;margin-top:auto}
    .signout-btn:hover{color:var(--white)}
    .main{padding:2rem 2.5rem;position:relative;z-index:1;max-width:1400px}
    .page-eyebrow{font-size:0.62rem;letter-spacing:0.22em;text-transform:uppercase;color:var(--red);margin-bottom:0.3rem}
    .page-title{font-family:'Bebas Neue',sans-serif;font-size:2.5rem;letter-spacing:0.04em;margin-bottom:0.4rem}

    /* Week nav */
    .week-nav{display:flex;align-items:center;gap:1rem;margin-bottom:2rem;flex-wrap:wrap}
    .week-nav-btn{background:none;border:1px solid var(--border-dim);border-radius:7px;padding:0.5rem 1rem;color:var(--light-gray);cursor:pointer;font-size:0.85rem;transition:all 0.2s;font-family:'DM Sans',sans-serif}
    .week-nav-btn:hover{border-color:var(--border);color:var(--white)}
    .week-nav-btn.today-btn{margin-left:auto}
    .week-label{font-size:1.05rem;color:var(--white);font-weight:500}
    .week-status{font-size:0.75rem;padding:0.25rem 0.75rem;border-radius:20px;margin-left:0.5rem}
    .status-confirmed{background:rgba(76,175,80,0.12);color:#4caf50;border:1px solid rgba(76,175,80,0.25)}
    .status-draft{background:rgba(255,152,0,0.1);color:#ff9800;border:1px solid rgba(255,152,0,0.2)}

    /* Suggest banner */
    .suggest-banner{background:rgba(204,0,0,0.07);border:1px solid var(--border);border-radius:12px;padding:1.1rem 1.5rem;margin-bottom:1.75rem;display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap}
    .suggest-text{font-size:0.88rem;color:var(--light-gray)}
    .suggest-text strong{color:var(--white)}
    .btn-suggest{background:var(--red);color:white;border:none;border-radius:7px;padding:0.55rem 1.25rem;font-family:'DM Sans',sans-serif;font-size:0.82rem;font-weight:500;cursor:pointer;transition:all 0.2s;text-transform:uppercase;letter-spacing:0.06em}
    .btn-suggest:hover{background:var(--red-bright);box-shadow:0 0 16px rgba(204,0,0,0.4)}

    /* Two-period layout */
    .periods-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:2rem}
    .period-section{background:var(--card);border:1px solid var(--border-dim);border-radius:14px;overflow:hidden}
    .period-header{padding:0.85rem 1.25rem;border-bottom:1px solid var(--border-dim);display:flex;align-items:center;justify-content:space-between}
    .period-title{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:0.05em}
    .period-badge-1st{color:#ff9944}
    .period-badge-6th{color:#66aaff}

    /* Role columns within period */
    .roles-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:0;border-top:1px solid var(--border-dim)}
    .role-col{border-right:1px solid var(--border-dim);padding:0}
    .role-col:last-child{border-right:none}
    .role-header{padding:0.6rem 0.85rem;border-bottom:1px solid var(--border-dim);text-align:center}
    .role-icon{font-size:1.1rem;display:block;margin-bottom:0.15rem}
    .role-name{font-size:0.65rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--light-gray)}
    .role-days{font-size:0.58rem;color:var(--gray);margin-top:0.1rem}
    .role-body{padding:0.75rem 0.85rem;min-height:80px}

    /* Team assignment card */
    .team-assignment{border-radius:8px;padding:0.6rem 0.75rem;margin-bottom:0.5rem;cursor:pointer;transition:all 0.2s;position:relative;border:1.5px solid transparent}
    .team-assignment:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,0,0,0.3)}
    .team-assignment.assigned{border-color:rgba(255,255,255,0.08)}
    .ta-name{font-size:0.82rem;font-weight:600}
    .ta-period-dot{width:6px;height:6px;border-radius:50%;display:inline-block;margin-right:0.3rem;vertical-align:middle}
    .ta-remove{position:absolute;top:0.35rem;right:0.35rem;background:none;border:none;color:rgba(255,255,255,0.25);cursor:pointer;font-size:0.75rem;transition:color 0.2s;padding:0}
    .ta-remove:hover{color:var(--red-bright)}
    .drop-zone{border:2px dashed rgba(255,255,255,0.08);border-radius:8px;padding:0.6rem;text-align:center;font-size:0.72rem;color:rgba(255,255,255,0.2);cursor:pointer;transition:all 0.2s;min-height:44px;display:flex;align-items:center;justify-content:center}
    .drop-zone:hover{border-color:rgba(204,0,0,0.3);color:var(--red-bright);background:rgba(204,0,0,0.04)}

    /* Unassigned teams pool */
    .unassigned-pool{background:var(--card);border:1px solid var(--border-dim);border-radius:14px;padding:1.25rem 1.5rem;margin-bottom:2rem}
    .pool-title{font-size:0.68rem;text-transform:uppercase;letter-spacing:0.12em;color:var(--gray);margin-bottom:0.85rem}
    .pool-teams{display:flex;flex-wrap:wrap;gap:0.5rem}
    .pool-chip{border-radius:8px;padding:0.45rem 0.9rem;font-size:0.82rem;font-weight:600;cursor:pointer;transition:all 0.2s;border:1.5px solid rgba(255,255,255,0.08)}
    .pool-chip:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.3)}
    .pool-chip.selected{outline:2px solid var(--red-bright);outline-offset:2px}

    /* Position assignment modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:100;display:none;align-items:center;justify-content:center}
    .modal-overlay.open{display:flex}
    .modal{background:#111;border:1px solid var(--border);border-radius:16px;padding:0;width:700px;max-width:95vw;max-height:90vh;overflow-y:auto}
    .modal-header{padding:1.5rem 1.75rem;border-bottom:1px solid var(--border-dim);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:#111;z-index:1}
    .modal-title{font-family:'Bebas Neue',sans-serif;font-size:1.6rem;letter-spacing:0.05em}
    .modal-close{background:none;border:none;color:var(--gray);font-size:1.2rem;cursor:pointer;transition:color 0.2s}
    .modal-close:hover{color:var(--white)}
    .modal-body{padding:1.5rem 1.75rem}

    /* Position day rows */
    .pos-day{margin-bottom:1.25rem}
    .pos-day-header{display:flex;align-items:center;gap:0.75rem;margin-bottom:0.6rem}
    .pos-day-name{font-size:0.72rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--light-gray);font-weight:500;min-width:80px}
    .pos-day-note{font-size:0.68rem;color:var(--gray)}
    .pos-students{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:0.5rem}
    .pos-row{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.03);border:1px solid var(--border-dim);border-radius:7px;padding:0.5rem 0.75rem}
    .pos-student-name{font-size:0.85rem}
    .pos-select{background:#0d0d0d;border:1px solid var(--border-dim);border-radius:5px;padding:0.3rem 0.5rem;color:var(--white);font-size:0.78rem;font-family:'DM Sans',sans-serif;outline:none;transition:border-color 0.2s}
    .pos-select:focus{border-color:var(--red)}
    .pos-select option{background:#1a1a1a}

    /* Confirm bar */
    .confirm-bar{background:rgba(204,0,0,0.07);border:1px solid var(--border);border-radius:12px;padding:1.1rem 1.5rem;display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap}
    .confirm-bar-text{font-size:0.88rem;color:var(--light-gray)}
    .btn-primary{background:var(--red);color:white;border:none;border-radius:8px;padding:0.82rem 1.75rem;font-family:'DM Sans',sans-serif;font-size:0.88rem;font-weight:500;cursor:pointer;transition:all 0.2s;text-transform:uppercase;letter-spacing:0.06em}
    .btn-primary:hover{background:var(--red-bright);box-shadow:0 0 20px rgba(204,0,0,0.4);transform:translateY(-1px)}
    .btn-primary:disabled{opacity:0.4;cursor:not-allowed;transform:none;box-shadow:none}
    .btn-ghost{background:transparent;color:var(--light-gray);border:1px solid var(--border-dim);border-radius:8px;padding:0.82rem 1.75rem;font-family:'DM Sans',sans-serif;font-size:0.88rem;cursor:pointer;transition:all 0.2s;text-transform:uppercase;letter-spacing:0.06em}
    .btn-ghost:hover{border-color:var(--border);color:var(--white)}
    .msg{padding:0.8rem 1rem;border-radius:8px;font-size:0.82rem;margin-top:0.75rem;display:none}
    .msg.success{background:rgba(0,200,80,0.08);border:1px solid rgba(0,200,80,0.2);color:#4caf50;display:block}
    .msg.error{background:rgba(204,0,0,0.1);border:1px solid var(--border);color:#ff6b6b;display:block}
    .empty-note{font-size:0.78rem;color:rgba(255,255,255,0.15);text-align:center;padding:1rem}

    @media(max-width:1100px){.layout{grid-template-columns:1fr}.sidebar{display:none}.main{padding:1.5rem}.periods-grid{grid-template-columns:1fr}.roles-grid{grid-template-columns:1fr 1fr}}
  </style>
</head>
<body>
<div class="layout">
  <aside class="sidebar">
    <img src="../logo.png" alt="The Birdhouse"/>
    <div class="admin-badge">‚öô Super Admin</div>
    <div class="nav-section">Overview</div>
    <a class="nav-item" href="index.html">üìä Dashboard</a>
    <div class="nav-section">Team</div>
    <a class="nav-item" href="roster.html">üë• Roster & Teams</a>
    <a class="nav-item active" href="schedule.html">üóìÔ∏è Schedule Builder</a>
    <a class="nav-item" href="index.html">üìù Weekly Summaries</a>
    <div class="nav-section">Menu</div>
    <a class="nav-item" href="index.html">‚òï Menu Manager</a>
    <button class="signout-btn" onclick="signOut()">‚Üê Sign Out</button>
  </aside>

  <main class="main">
    <div class="page-eyebrow">Super Admin</div>
    <div style="display:flex;align-items:baseline;gap:1rem;margin-bottom:0.4rem">
      <h1 class="page-title" style="margin-bottom:0">Schedule Builder</h1>
      <span class="week-status status-draft" id="week-status-badge">Draft</span>
    </div>
    <p style="color:var(--gray);font-size:0.88rem;margin-bottom:1.75rem">Assign teams to roles for the week. Click a role slot to set daily positions.</p>

    <!-- Week navigation -->
    <div class="week-nav">
      <button class="week-nav-btn" onclick="changeWeek(-1)">‚Üê Prev Week</button>
      <span class="week-label" id="week-label">‚Äî</span>
      <button class="week-nav-btn" onclick="changeWeek(1)">Next Week ‚Üí</button>
      <button class="week-nav-btn today-btn" onclick="weekOffset=0;loadWeek()">This Week</button>
    </div>

    <!-- Rotation suggestion banner -->
    <div class="suggest-banner" id="suggest-banner" style="display:none">
      <div class="suggest-text">
        <strong>Suggested rotation ready</strong> ‚Äî based on last week's assignments. Review and confirm, or adjust manually below.
      </div>
      <button class="btn-suggest" onclick="applySuggestion()">Apply Suggestion ‚Üí</button>
    </div>

    <!-- Unassigned teams pool -->
    <div class="unassigned-pool">
      <div class="pool-title">Unassigned Teams ‚Äî click a team, then click a role slot to assign</div>
      <div class="pool-teams" id="pool-teams"><em style="color:var(--gray);font-size:0.82rem">Loading...</em></div>
    </div>

    <!-- 1st Hour + 6th Hour side by side -->
    <div class="periods-grid" id="periods-grid">
      <!-- populated by JS -->
    </div>

    <!-- Confirm bar -->
    <div class="confirm-bar">
      <div class="confirm-bar-text" id="confirm-bar-text">Assign all teams to publish this week's schedule.</div>
      <div style="display:flex;gap:0.75rem">
        <button class="btn-ghost" onclick="clearWeek()">Clear Week</button>
        <button class="btn-primary" id="confirm-btn" onclick="confirmWeek()">‚úì Confirm & Publish</button>
      </div>
    </div>
    <div class="msg" id="page-msg"></div>
  </main>
</div>

<!-- Position Assignment Modal -->
<div class="modal-overlay" id="pos-modal">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-title" id="pos-modal-title">Assign Positions</div>
        <div style="font-size:0.78rem;color:var(--gray);margin-top:0.2rem" id="pos-modal-sub"></div>
      </div>
      <button class="modal-close" onclick="closePosModal()">‚úï</button>
    </div>
    <div class="modal-body" id="pos-modal-body"></div>
    <div style="padding:1rem 1.75rem 1.5rem;border-top:1px solid var(--border-dim);display:flex;gap:1rem;justify-content:flex-end">
      <button class="btn-ghost" onclick="closePosModal()">Cancel</button>
      <button class="btn-primary" onclick="savePositions()">Save Positions</button>
    </div>
  </div>
</div>

<script>
const sb = supabase.createClient('https://ljukrhneikqbabcmcpet.supabase.co','sb_publishable_lWdxpZUHbQHiz04wthAC2g_X4ToxDCn');

const ROLES = [
  {key:'birdhouse', label:'Birdhouse', icon:'üè†', days:['Mon','Tue','Wed','Thu','Fri'], hasPositions:true},
  {key:'mathews',   label:'Mathews',   icon:'üè´', days:['Mon','Wed','Fri'], note:'Tue/Thu = In Class', hasPositions:true},
  {key:'menu',      label:'Menu Prep', icon:'üìã', days:['In Class all week'], hasPositions:false},
  {key:'inclass',   label:'In Class',  icon:'üìö', days:['All week'], hasPositions:false},
];
const BIRDHOUSE_POSITIONS = ['cashier','barista','stocker','custodian'];
const MATHEWS_POSITIONS   = ['deliverer','barista','stocker','custodian'];
const POSITIONS = BIRDHOUSE_POSITIONS; // default
const POSITION_LABELS = {cashier:'Cashier',barista:'Barista',stocker:'Stocker',custodian:'Custodian',deliverer:'Deliverer'};
const ROTATION_ORDER = ['birdhouse','mathews','menu','inclass'];

let weekOffset=0, allTeams=[], assignments={}, selectedTeam=null, posModalData=null, weekStudents={};

async function init() {
  const {data:{session}} = await sb.auth.getSession();
  if(!session||session.user.user_metadata?.role!=='admin'){window.location.href='login.html';return;}
  await loadTeams();
  await loadWeek();
}

function getMondayOfWeek(offset=0) {
  const today=new Date();
  const day=today.getDay();
  const diff=day===0?-6:1-day;
  const monday=new Date(today);
  monday.setDate(today.getDate()+diff+(offset*7));
  monday.setHours(0,0,0,0);
  return monday;
}
function fmtDate(d){return d.toISOString().split('T')[0];}
function fmtTime(t){if(!t)return'‚Äî';const[h,m]=t.split(':');const hr=parseInt(h);return`${hr>12?hr-12:hr||12}:${m} ${hr>=12?'PM':'AM'}`;}
function addDays(d,n){const r=new Date(d);r.setDate(r.getDate()+n);return r;}

async function loadTeams() {
  const {data} = await sb.from('teams').select('*,students(id,first_name,last_name)').order('name');
  allTeams = data||[];
}

async function loadWeek() {
  const monday = getMondayOfWeek(weekOffset);
  const friday = addDays(monday,4);
  document.getElementById('week-label').textContent =
    `Week of ${monday.toLocaleDateString('en-US',{month:'short',day:'numeric'})} ‚Äì ${friday.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}`;

  // Load assignments for this week
  const {data:rows} = await sb.from('weekly_assignments').select('*').eq('week_start',fmtDate(monday));
  assignments = {};
  let allConfirmed = rows?.length>0 && rows.every(r=>r.confirmed);
  (rows||[]).forEach(r=>{ assignments[r.team_id]={...r}; });

  // Update status badge
  const badge=document.getElementById('week-status-badge');
  if(allConfirmed && rows?.length>0){badge.textContent='Published';badge.className='week-status status-confirmed';}
  else{badge.textContent='Draft';badge.className='week-status status-draft';}

  // Check if suggestion available (any team unassigned)
  const assignedCount = Object.keys(assignments).length;
  document.getElementById('suggest-banner').style.display = assignedCount===0?'flex':'none';

  renderPool();
  renderPeriods();
}

function getTeamRole(teamId) {
  return assignments[teamId]?.role||null;
}

function renderPool() {
  const pool=document.getElementById('pool-teams');
  const unassigned=allTeams.filter(t=>!getTeamRole(t.id));
  if(!unassigned.length){pool.innerHTML='<span style="color:#4caf50;font-size:0.82rem">‚úì All teams assigned for this week</span>';return;}
  pool.innerHTML=unassigned.map(t=>`
    <div class="pool-chip ${selectedTeam?.id===t.id?'selected':''}"
      style="background:${t.color}18;color:${t.color};border-color:${t.color}33"
      onclick="selectTeam('${t.id}')">
      ${t.name}
      <span style="font-size:0.68rem;opacity:0.7;margin-left:0.3rem">${t.period==='1st Hour'?'1st':'6th'}</span>
    </div>`).join('');
}

function selectTeam(teamId) {
  selectedTeam = selectedTeam?.id===teamId ? null : allTeams.find(t=>t.id===teamId);
  renderPool();
}

function renderPeriods() {
  const grid=document.getElementById('periods-grid');
  grid.innerHTML=['1st Hour','6th Hour'].map(period=>{
    const periodTeams=allTeams.filter(t=>t.period===period);
    const periodClass=period==='1st Hour'?'period-badge-1st':'period-badge-6th';
    return `<div class="period-section">
      <div class="period-header">
        <div class="period-title ${periodClass}">${period}</div>
        <div style="font-size:0.75rem;color:var(--gray)">${periodTeams.length} teams</div>
      </div>
      <div class="roles-grid">
        ${ROLES.map(role=>`
          <div class="role-col">
            <div class="role-header">
              <span class="role-icon">${role.icon}</span>
              <div class="role-name">${role.label}</div>
              <div class="role-days">${Array.isArray(role.days)?role.days.join('/'):role.days}</div>
            </div>
            <div class="role-body" id="role-${period.replace(' ','')}-${role.key}">
              ${renderRoleBody(period, role, periodTeams)}
            </div>
          </div>`).join('')}
      </div>
    </div>`;
  }).join('');
}

function renderRoleBody(period, role, periodTeams) {
  const assigned=periodTeams.filter(t=>getTeamRole(t.id)===role.key);
  let html=assigned.map(t=>`
    <div class="team-assignment assigned" style="background:${t.color}15;border-color:${t.color}33">
      <button class="ta-remove" onclick="unassignTeam('${t.id}',event)">‚úï</button>
      <div class="ta-name" style="color:${t.color}">${t.name}</div>
      <div style="font-size:0.7rem;color:var(--gray);margin-top:0.2rem">
        ${(t.students||[]).length} students
        ${role.hasPositions?`<span style="color:var(--red-bright);margin-left:0.4rem;cursor:pointer" onclick="openPosModal('${t.id}','${role.key}',event)">¬∑ Set positions</span>`:''}
      </div>
    </div>`).join('');

  // Menu role: only allow 1 total across both periods
  const menuAssignedAnywhere = role.key==='menu' && allTeams.some(t=>getTeamRole(t.id)==='menu');
  const canAdd = role.key==='menu' ? !menuAssignedAnywhere : true;

  html+=`<div class="drop-zone" onclick="assignTeamToRole('${period}','${role.key}')">
    ${canAdd?'+ Assign team':'<span style="color:var(--gray)">1 team max</span>'}
  </div>`;
  return html;
}

function assignTeamToRole(period, roleKey) {
  if(!selectedTeam){alert('Select a team from the pool above first.');return;}
  if(selectedTeam.period!==period){alert(`${selectedTeam.name} is a ${selectedTeam.period} team ‚Äî assign it to the ${selectedTeam.period} column.`);return;}
  if(roleKey==='menu' && allTeams.some(t=>getTeamRole(t.id)==='menu')){alert('Only one team per week can be on Menu Prep.');return;}
  // Save to local state
  const monday=getMondayOfWeek(weekOffset);
  assignments[selectedTeam.id]={team_id:selectedTeam.id, week_start:fmtDate(monday), role:roleKey, confirmed:false, _local:true};
  selectedTeam=null;
  renderPool();
  renderPeriods();
}

function unassignTeam(teamId, e) {
  e.stopPropagation();
  delete assignments[teamId];
  if(selectedTeam?.id===teamId) selectedTeam=null;
  renderPool();
  renderPeriods();
}

// ‚îÄ‚îÄ Rotation Suggestion ‚îÄ‚îÄ
function buildSuggestion() {
  // Rotate each team to the next role in cycle
  const cycleMap={'birdhouse':'mathews','mathews':'menu','menu':'inclass','inclass':'birdhouse',null:'birdhouse'};
  const monday=getMondayOfWeek(weekOffset);
  allTeams.forEach(t=>{
    const lastRole=t.last_role||null;
    const nextRole=cycleMap[lastRole];
    // Menu: only assign one team total ‚Äî skip if already assigned
    if(nextRole==='menu' && allTeams.some(t2=>t2.id!==t.id&&(assignments[t2.id]?.role==='menu'||t2.last_role_next==='menu'))) {
      assignments[t.id]={team_id:t.id,week_start:fmtDate(monday),role:'inclass',confirmed:false,_local:true};
    } else {
      assignments[t.id]={team_id:t.id,week_start:fmtDate(monday),role:nextRole,confirmed:false,_local:true};
      t.last_role_next=nextRole;
    }
  });
}

function applySuggestion() {
  buildSuggestion();
  document.getElementById('suggest-banner').style.display='none';
  renderPool();
  renderPeriods();
}

// ‚îÄ‚îÄ Position Modal ‚îÄ‚îÄ
async function openPosModal(teamId, roleKey, e) {
  e?.stopPropagation();
  const team=allTeams.find(t=>t.id===teamId);
  if(!team) return;
  const students=team.students||[];
  if(!students.length){alert('No students assigned to this team yet. Go to Roster & Teams first.');return;}
  const role=ROLES.find(r=>r.key===roleKey);
  const monday=getMondayOfWeek(weekOffset);

  // Working days for this role
  let workingDays=[];
  if(roleKey==='birdhouse') workingDays=[0,1,2,3,4].map(i=>({date:addDays(monday,i),name:['Monday','Tuesday','Wednesday','Thursday','Friday'][i]}));
  if(roleKey==='mathews')   workingDays=[0,2,4].map(i=>({date:addDays(monday,i),name:['Monday','Wednesday','Friday'][i]}));

  // Load existing positions
  const {data:existing} = await sb.from('daily_positions').select('*')
    .in('shift_date', workingDays.map(d=>fmtDate(d.date)))
    .in('student_id', students.map(s=>s.id));
  const posMap={};
  (existing||[]).forEach(p=>{ posMap[`${p.student_id}_${p.shift_date}`]=p.position; });

  // Use correct position set for this role
  const posSet = roleKey==='mathews' ? MATHEWS_POSITIONS : BIRDHOUSE_POSITIONS;

  // Auto-assign if empty
  if(!existing?.length) {
    students.forEach((s,si)=>{
      workingDays.forEach((d,di)=>{
        posMap[`${s.id}_${fmtDate(d.date)}`]=posSet[(si+di)%posSet.length];
      });
    });
  }

  posModalData={teamId, roleKey, team, students, workingDays, posMap};

  document.getElementById('pos-modal-title').textContent=`${team.name} ‚Äî Position Assignments`;
  document.getElementById('pos-modal-sub').textContent=`${role.label} ¬∑ ${team.period}`;
  document.getElementById('pos-modal-body').innerHTML=buildPosModalBody();
  document.getElementById('pos-modal').classList.add('open');
}

function buildPosModalBody() {
  const {students, workingDays, posMap}=posModalData;
  return workingDays.map(d=>{
    const dateStr=fmtDate(d.date);
    return `<div class="pos-day">
      <div class="pos-day-header">
        <span class="pos-day-name">${d.name}</span>
        <span class="pos-day-note">${d.date.toLocaleDateString('en-US',{month:'short',day:'numeric'})}</span>
      </div>
      <div class="pos-students">
        ${students.map(s=>`
          <div class="pos-row">
            <span class="pos-student-name">${s.first_name} ${s.last_name}</span>
            <select class="pos-select" id="pos_${s.id}_${dateStr}">
              ${posSet.map(p=>`<option value="${p}" ${posMap[`${s.id}_${dateStr}`]===p?'selected':''}>${POSITION_LABELS[p]}</option>`).join('')}
            </select>
          </div>`).join('')}
      </div>
    </div>`;
  }).join('');
}

async function savePositions() {
  const {teamId, students, workingDays}=posModalData;
  const rows=[];
  workingDays.forEach(d=>{
    const dateStr=fmtDate(d.date);
    const assignmentId=Object.values(assignments).find(a=>a.team_id===teamId)?.id||null;
    students.forEach(s=>{
      const pos=document.getElementById(`pos_${s.id}_${dateStr}`)?.value;
      if(pos) rows.push({assignment_id:assignmentId, student_id:s.id, shift_date:dateStr, position:pos});
    });
  });
  // Upsert
  await sb.from('daily_positions').upsert(rows,{onConflict:'student_id,shift_date'});
  closePosModal();
  // Show quick success
  const m=document.getElementById('page-msg');
  m.textContent='‚úì Positions saved!';m.className='msg success';
  setTimeout(()=>m.style.display='none',3000);
}

function closePosModal(){document.getElementById('pos-modal').classList.remove('open');}

// ‚îÄ‚îÄ Confirm & Publish ‚îÄ‚îÄ
async function confirmWeek() {
  const monday=getMondayOfWeek(weekOffset);
  const unassigned=allTeams.filter(t=>!getTeamRole(t.id));
  if(unassigned.length){
    if(!confirm(`${unassigned.map(t=>t.name).join(', ')} ${unassigned.length===1?'is':'are'} not assigned. Publish anyway?`)) return;
  }
  const btn=document.getElementById('confirm-btn');
  btn.disabled=true;btn.textContent='Publishing...';

  // Upsert all assignments
  const rows=Object.values(assignments).map(a=>({
    team_id:a.team_id, week_start:fmtDate(monday), role:a.role, confirmed:true
  }));
  const {error}=await sb.from('weekly_assignments').upsert(rows,{onConflict:'team_id,week_start'});

  if(!error) {
    // Update last_role on each team
    await Promise.all(Object.values(assignments).map(a=>
      sb.from('teams').update({last_role:a.role, last_role_week:fmtDate(monday)}).eq('id',a.team_id)
    ));
    const badge=document.getElementById('week-status-badge');
    badge.textContent='Published';badge.className='week-status status-confirmed';
    const m=document.getElementById('page-msg');
    m.textContent='‚úì Schedule published! Students can now see their assignments.';m.className='msg success';
    // Reload teams to get updated last_role
    await loadTeams();
  }
  btn.disabled=false;btn.textContent='‚úì Confirm & Publish';
}

async function clearWeek() {
  if(!confirm('Clear all assignments for this week?')) return;
  const monday=getMondayOfWeek(weekOffset);
  await sb.from('weekly_assignments').delete().eq('week_start',fmtDate(monday));
  assignments={};
  selectedTeam=null;
  await loadTeams();
  renderPool();
  renderPeriods();
}

function changeWeek(dir){weekOffset+=dir;loadWeek();}
async function signOut(){await sb.auth.signOut();window.location.href='login.html';}
init();
</script>
</body>
</html>
