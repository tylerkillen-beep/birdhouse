<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Birdhouse ‚Äî My Account</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --cream: #f5f0e8;
      --brown: #2c1a0e;
      --amber: #c47d2e;
      --amber-light: #e8a94a;
      --warm-gray: #8a7968;
      --card: #fff8f0;
      --border: rgba(44,26,14,0.1);
    }
    body { background: var(--cream); color: var(--brown); font-family: 'DM Sans', sans-serif; min-height: 100vh; }

    /* Sidebar layout */
    .layout { display: grid; grid-template-columns: 240px 1fr; min-height: 100vh; }

    /* Sidebar */
    .sidebar {
      background: var(--brown);
      padding: 2rem 1.5rem;
      position: sticky; top: 0; height: 100vh;
      display: flex; flex-direction: column;
    }
    .sidebar-logo { display: flex; align-items: center; gap: 0.6rem; margin-bottom: 2.5rem; color: var(--cream); }
    .sidebar-logo-text { font-family: 'Playfair Display', serif; font-size: 1.1rem; }

    .user-card {
      background: rgba(245,240,232,0.08); border-radius: 12px; padding: 1rem; margin-bottom: 2rem;
    }
    .user-avatar {
      width: 40px; height: 40px; background: var(--amber); border-radius: 50%;
      display: flex; align-items: center; justify-content: center; font-size: 1rem; margin-bottom: 0.6rem;
    }
    .user-name { font-size: 0.9rem; color: var(--cream); font-weight: 500; }
    .user-points { font-size: 0.75rem; color: var(--amber-light); margin-top: 0.2rem; }

    nav { flex: 1; }
    .nav-item {
      display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: 8px;
      color: rgba(245,240,232,0.6); font-size: 0.88rem; text-decoration: none; cursor: pointer;
      transition: all 0.2s; margin-bottom: 0.25rem;
    }
    .nav-item:hover, .nav-item.active { background: rgba(245,240,232,0.1); color: var(--cream); }
    .nav-item.active { background: rgba(196,125,46,0.2); color: var(--amber-light); }

    .signout-btn { background: none; border: 1px solid rgba(245,240,232,0.15); border-radius: 8px; padding: 0.65rem 1rem; color: rgba(245,240,232,0.5); font-size: 0.82rem; cursor: pointer; width: 100%; text-align: left; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem; }
    .signout-btn:hover { color: var(--cream); border-color: rgba(245,240,232,0.3); }

    /* Main */
    .main { padding: 2.5rem 3rem; }

    .page-header { margin-bottom: 2rem; }
    .page-eyebrow { font-size: 0.72rem; letter-spacing: 0.18em; text-transform: uppercase; color: var(--amber); margin-bottom: 0.3rem; }
    .page-title { font-family: 'Playfair Display', serif; font-size: 2rem; }

    /* Stats grid */
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem; }
    .stat-card {
      background: var(--card); border-radius: 14px; padding: 1.5rem;
      border: 1px solid var(--border);
    }
    .stat-label { font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--warm-gray); margin-bottom: 0.5rem; }
    .stat-value { font-family: 'Playfair Display', serif; font-size: 2.2rem; color: var(--amber); }
    .stat-sub { font-size: 0.78rem; color: var(--warm-gray); margin-top: 0.25rem; }

    /* Points progress */
    .points-bar-wrap { margin-top: 0.75rem; }
    .points-bar { height: 6px; background: rgba(44,26,14,0.1); border-radius: 3px; overflow: hidden; }
    .points-fill { height: 100%; background: var(--amber); border-radius: 3px; transition: width 0.8s ease; }

    /* Section */
    .section { margin-bottom: 2rem; }
    .section-title { font-family: 'Playfair Display', serif; font-size: 1.2rem; margin-bottom: 1rem; }

    /* Order button */
    .order-btn {
      display: inline-flex; align-items: center; gap: 0.5rem; background: var(--brown); color: var(--cream);
      border: none; border-radius: 10px; padding: 0.85rem 1.5rem; font-family: 'DM Sans', sans-serif;
      font-size: 0.9rem; cursor: pointer; text-decoration: none; transition: background 0.2s, transform 0.15s;
    }
    .order-btn:hover { background: var(--amber); transform: translateY(-1px); }

    /* Subscription card */
    .subscription-card {
      background: var(--brown); color: var(--cream); border-radius: 16px; padding: 2rem;
      display: flex; justify-content: space-between; align-items: center;
    }
    .sub-tier { font-family: 'Playfair Display', serif; font-size: 1.5rem; margin-bottom: 0.25rem; }
    .sub-detail { font-size: 0.85rem; opacity: 0.6; }
    .sub-badge { background: var(--amber); color: var(--cream); border-radius: 20px; padding: 0.4rem 1rem; font-size: 0.8rem; font-weight: 500; }
    .no-sub { background: var(--card); border: 1.5px dashed var(--border); border-radius: 16px; padding: 2rem; text-align: center; }
    .no-sub p { color: var(--warm-gray); margin-bottom: 1rem; font-size: 0.9rem; }

    /* Order history */
    .orders-list { }
    .order-item {
      background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem 1.5rem;
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;
    }
    .order-drink { font-weight: 500; }
    .order-meta { font-size: 0.8rem; color: var(--warm-gray); margin-top: 0.2rem; }
    .order-points { color: var(--amber); font-size: 0.85rem; font-weight: 500; }
    .no-orders { color: var(--warm-gray); font-size: 0.9rem; text-align: center; padding: 2rem; }

    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
      .sidebar { display: none; }
      .main { padding: 1.5rem; }
      .stats-grid { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>

<div class="layout">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <span style="font-size:1.4rem">ü¶Ö</span>
      <span class="sidebar-logo-text">The Birdhouse</span>
    </div>

    <div class="user-card">
      <div class="user-avatar">‚òï</div>
      <div class="user-name" id="user-display-name">Loading...</div>
      <div class="user-points" id="user-points-badge">0 points</div>
    </div>

    <nav>
      <a class="nav-item active" onclick="showSection('overview')">üìä Overview</a>
      <a class="nav-item" onclick="showSection('order')">‚òï Place an Order</a>
      <a class="nav-item" onclick="showSection('history')">üìã Order History</a>
      <a class="nav-item" onclick="showSection('subscription')">üì¶ My Subscription</a>
      <a class="nav-item" onclick="showSection('loyalty')">‚≠ê Loyalty Rewards</a>
    </nav>

    <button class="signout-btn" onclick="signOut()">‚Üê Sign Out</button>
  </aside>

  <!-- Main content -->
  <main class="main">

    <!-- Overview Section -->
    <div id="section-overview">
      <div class="page-header">
        <div class="page-eyebrow">Customer Portal</div>
        <h1 class="page-title">Good morning, <span id="greeting-name">Eagle</span>. ‚òï</h1>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Loyalty Points</div>
          <div class="stat-value" id="stat-points">0</div>
          <div class="stat-sub">Next reward at 100 pts</div>
          <div class="points-bar-wrap">
            <div class="points-bar"><div class="points-fill" id="points-fill" style="width:0%"></div></div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Orders</div>
          <div class="stat-value" id="stat-orders">0</div>
          <div class="stat-sub">All time</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Subscription</div>
          <div class="stat-value" id="stat-sub">‚Äî</div>
          <div class="stat-sub" id="stat-sub-detail">No active plan</div>
        </div>
      </div>

      <div class="section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem">
          <div class="section-title">Quick Order</div>
        </div>
        <a class="order-btn" onclick="showSection('order')">‚òï Order Now ‚Üí</a>
      </div>

      <div class="section">
        <div class="section-title">Recent Orders</div>
        <div id="recent-orders-list"><div class="no-orders">No orders yet. Place your first order!</div></div>
      </div>
    </div>

    <!-- Order Section -->
    <div id="section-order" style="display:none">
      <div class="page-header">
        <div class="page-eyebrow">Place an Order</div>
        <h1 class="page-title">What are you having?</h1>
      </div>
      <p style="color:var(--warm-gray); margin-bottom:2rem">Menu items are loaded from the store configuration.</p>
      <div id="menu-items" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); gap:1rem;"></div>
    </div>

    <!-- History Section -->
    <div id="section-history" style="display:none">
      <div class="page-header">
        <div class="page-eyebrow">Your Orders</div>
        <h1 class="page-title">Order History</h1>
      </div>
      <div id="full-orders-list"><div class="no-orders">No orders yet.</div></div>
    </div>

    <!-- Subscription Section -->
    <div id="section-subscription" style="display:none">
      <div class="page-header">
        <div class="page-eyebrow">Subscription</div>
        <h1 class="page-title">My Plan</h1>
      </div>
      <div id="subscription-display"></div>
      <div style="margin-top:2rem">
        <a class="order-btn" href="../index.html">Browse Subscription Plans ‚Üí</a>
      </div>
    </div>

    <!-- Loyalty Section -->
    <div id="section-loyalty" style="display:none">
      <div class="page-header">
        <div class="page-eyebrow">Rewards</div>
        <h1 class="page-title">Loyalty Points</h1>
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Current Points</div>
          <div class="stat-value" id="loyalty-points">0</div>
          <div class="stat-sub">1 point per drink ordered</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Drinks to Next Reward</div>
          <div class="stat-value" id="loyalty-to-reward">10</div>
          <div class="stat-sub">Free drink at 100 points</div>
        </div>
      </div>
      <div style="margin-top:1.5rem; background:var(--card); border-radius:14px; padding:1.5rem; border:1px solid var(--border)">
        <div class="section-title" style="margin-bottom:0.75rem">How it works</div>
        <p style="color:var(--warm-gray); font-size:0.9rem; line-height:1.7">
          Earn 1 loyalty point for every drink you order. When you reach 100 points, you earn a free drink of your choice. Subscription orders also earn points!
        </p>
      </div>
    </div>

  </main>
</div>

<script>
  const SUPABASE_URL = 'https://ljukrhneikqbabcmcpet.supabase.co';
  const SUPABASE_ANON_KEY = 'sb_publishable_lWdxpZUHbQHiz04wthAC2g_X4ToxDCn';
  const { createClient } = supabase;
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let currentUser = null;
  let userMeta = null;

  async function init() {
    const { data: { session } } = await sb.auth.getSession();
    if (!session) { window.location.href = 'index.html'; return; }
    currentUser = session.user;
    userMeta = currentUser.user_metadata;

    const firstName = userMeta.first_name || 'Eagle';
    document.getElementById('user-display-name').textContent = firstName + ' ' + (userMeta.last_name || '');
    document.getElementById('greeting-name').textContent = firstName;

    const points = userMeta.loyalty_points || 0;
    document.getElementById('user-points-badge').textContent = points + ' points';
    document.getElementById('stat-points').textContent = points;
    document.getElementById('loyalty-points').textContent = points;
    document.getElementById('loyalty-to-reward').textContent = Math.max(0, 100 - (points % 100));
    document.getElementById('points-fill').style.width = Math.min(100, (points % 100)) + '%';

    const sub = userMeta.subscription_tier || null;
    document.getElementById('stat-sub').textContent = sub || '‚Äî';
    document.getElementById('stat-sub-detail').textContent = sub ? 'Active plan' : 'No active plan';

    loadOrders();
    loadSubscription();
  }

  async function loadOrders() {
    const { data, error } = await sb.from('orders').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false }).limit(5);
    if (error || !data || data.length === 0) return;

    const renderOrders = (list, containerId) => {
      const container = document.getElementById(containerId);
      if (!list.length) return;
      container.innerHTML = list.map(o => `
        <div class="order-item">
          <div>
            <div class="order-drink">${o.drink_name}</div>
            <div class="order-meta">${new Date(o.created_at).toLocaleDateString()} ¬∑ Room ${o.room || '‚Äî'}</div>
          </div>
          <div class="order-points">+${o.points_earned || 1} pt</div>
        </div>
      `).join('');
    };

    document.getElementById('stat-orders').textContent = data.length;
    renderOrders(data.slice(0,3), 'recent-orders-list');
    renderOrders(data, 'full-orders-list');
  }

  function loadSubscription() {
    const sub = userMeta.subscription_tier;
    const container = document.getElementById('subscription-display');
    if (sub) {
      container.innerHTML = `
        <div class="subscription-card">
          <div>
            <div class="sub-tier">${sub}</div>
            <div class="sub-detail">Active subscription ¬∑ Renews monthly</div>
          </div>
          <div class="sub-badge">Active ‚úì</div>
        </div>`;
    } else {
      container.innerHTML = `
        <div class="no-sub">
          <p>You don't have an active subscription yet.</p>
          <a class="order-btn" href="../index.html">View Subscription Plans ‚Üí</a>
        </div>`;
    }
  }

  function showSection(name) {
    document.querySelectorAll('[id^="section-"]').forEach(el => el.style.display = 'none');
    document.getElementById('section-' + name).style.display = 'block';
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    event.target.classList.add('active');
  }

  async function signOut() {
    await sb.auth.signOut();
    window.location.href = 'index.html';
  }

  init();
</script>

</body>
</html>
