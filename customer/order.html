<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Birdhouse ‚Äî Place an Order</title>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --black: #0a0a0a; --red: #cc0000; --red-bright: #ff1a1a;
      --gray: #555; --light-gray: #999; --white: #f0f0f0;
      --card: #141414; --border: rgba(204,0,0,0.18); --border-dim: rgba(255,255,255,0.07);
    }
    body { background: var(--black); color: var(--white); font-family: 'DM Sans', sans-serif; min-height: 100vh; }
    body::before { content:''; position:fixed; inset:0; background-image:linear-gradient(rgba(204,0,0,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(204,0,0,0.03) 1px,transparent 1px); background-size:40px 40px; pointer-events:none; z-index:0; }

    .layout { display:grid; grid-template-columns:220px 1fr; min-height:100vh; }
    .sidebar { background:#0d0000; border-right:1px solid var(--border); padding:1.75rem 1.25rem; position:sticky; top:0; height:100vh; display:flex; flex-direction:column; }
    .sidebar-logo img { height:38px; filter:drop-shadow(0 0 8px rgba(204,0,0,0.5)); margin-bottom:2rem; }
    .user-card { background:rgba(204,0,0,0.08); border:1px solid var(--border); border-radius:10px; padding:1rem; margin-bottom:1.75rem; }
    .user-name { font-size:0.9rem; color:var(--white); font-weight:500; }
    .user-points { font-size:0.72rem; color:var(--red-bright); margin-top:0.25rem; }
    nav { flex:1; }
    .nav-item { display:flex; align-items:center; gap:0.7rem; padding:0.7rem 0.9rem; border-radius:7px; color:var(--gray); font-size:0.85rem; text-decoration:none; cursor:pointer; transition:all 0.2s; margin-bottom:0.2rem; border:1px solid transparent; }
    .nav-item:hover { color:var(--white); background:rgba(255,255,255,0.04); }
    .nav-item.active { background:rgba(204,0,0,0.12); color:var(--red-bright); border-color:rgba(204,0,0,0.25); }
    .signout-btn { background:none; border:1px solid rgba(255,255,255,0.08); border-radius:7px; padding:0.65rem 1rem; color:var(--gray); font-size:0.8rem; cursor:pointer; width:100%; text-align:left; transition:all 0.2s; display:flex; align-items:center; gap:0.5rem; font-family:'DM Sans',sans-serif; }
    .signout-btn:hover { color:var(--white); }

    .main { padding:2.5rem 3rem; position:relative; z-index:1; }
    .page-eyebrow { font-size:0.65rem; letter-spacing:0.2em; text-transform:uppercase; color:var(--red); margin-bottom:0.3rem; }
    .page-title { font-family:'Bebas Neue',sans-serif; font-size:2.5rem; letter-spacing:0.04em; margin-bottom:0.5rem; }
    .page-sub { color:var(--light-gray); font-size:0.88rem; margin-bottom:2rem; }

    /* Steps */
    .steps { display:flex; align-items:center; margin-bottom:2.5rem; flex-wrap:wrap; gap:0.5rem; }
    .step { display:flex; align-items:center; gap:0.6rem; font-size:0.78rem; text-transform:uppercase; letter-spacing:0.08em; color:var(--gray); }
    .step.active { color:var(--red-bright); }
    .step.done { color:var(--light-gray); }
    .step-num { width:26px; height:26px; border-radius:50%; border:1px solid currentColor; display:flex; align-items:center; justify-content:center; font-size:0.72rem; flex-shrink:0; }
    .step.active .step-num { background:var(--red); border-color:var(--red); color:white; }
    .step.done .step-num { background:rgba(255,255,255,0.1); }
    .step-line { flex:1; height:1px; background:rgba(255,255,255,0.06); margin:0 0.75rem; max-width:50px; }

    .step-panel { display:none; }
    .step-panel.active { display:block; }

    /* Step 1 ‚Äî Menu */
    .category-label { font-size:0.65rem; letter-spacing:0.18em; text-transform:uppercase; color:var(--red); margin:1.5rem 0 0.75rem; }
    .category-label:first-child { margin-top:0; }
    .menu-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(210px,1fr)); gap:0.85rem; margin-bottom:0.5rem; }
    .menu-card { background:var(--card); border:1px solid var(--border-dim); border-radius:12px; padding:1.25rem; cursor:pointer; transition:all 0.2s; position:relative; }
    .menu-card:hover { border-color:var(--border); transform:translateY(-2px); }
    .menu-card.selected { border-color:var(--red); background:rgba(204,0,0,0.08); box-shadow:0 0 20px rgba(204,0,0,0.15); }
    .menu-card-name { font-weight:500; font-size:0.95rem; margin-bottom:0.25rem; }
    .menu-card-desc { font-size:0.78rem; color:var(--gray); line-height:1.4; margin-bottom:0.6rem; }
    .menu-card-tags { display:flex; gap:0.4rem; flex-wrap:wrap; }
    .tag { font-size:0.65rem; padding:0.2rem 0.55rem; border-radius:20px; border:1px solid var(--border-dim); color:var(--light-gray); }
    .tag.hot { border-color:rgba(255,120,0,0.3); color:#ff9944; }
    .tag.iced { border-color:rgba(80,160,255,0.3); color:#66aaff; }
    .menu-card-check { position:absolute; top:0.85rem; right:0.85rem; width:20px; height:20px; border-radius:50%; background:var(--red); display:none; align-items:center; justify-content:center; font-size:0.7rem; }
    .menu-card.selected .menu-card-check { display:flex; }
    .no-menu { color:var(--gray); text-align:center; padding:3rem; font-size:0.9rem; background:var(--card); border-radius:12px; border:1px solid var(--border-dim); }

    /* Step 2 ‚Äî Customize */
    .customize-grid { display:grid; grid-template-columns:1fr 1fr; gap:2rem; max-width:700px; }
    .form-group { margin-bottom:1.25rem; }
    label { display:block; font-size:0.7rem; font-weight:500; letter-spacing:0.1em; text-transform:uppercase; color:var(--gray); margin-bottom:0.5rem; }
    .option-row { display:flex; flex-wrap:wrap; gap:0.5rem; }

    /* Temp type selector ‚Äî bigger, prominent */
    .temp-selector { display:flex; gap:1rem; margin-bottom:1.5rem; }
    .temp-btn { flex:1; padding:1.1rem 1rem; border-radius:12px; border:1.5px solid var(--border-dim); background:var(--card); cursor:pointer; font-family:'DM Sans',sans-serif; font-size:0.9rem; font-weight:500; color:var(--gray); transition:all 0.2s; text-align:center; }
    .temp-btn .temp-icon { font-size:1.6rem; display:block; margin-bottom:0.4rem; }
    .temp-btn .temp-size { font-size:0.72rem; color:var(--gray); margin-top:0.2rem; letter-spacing:0.05em; }
    .temp-btn.hot-btn.selected { border-color:rgba(255,120,0,0.6); background:rgba(255,100,0,0.08); color:#ff9944; box-shadow:0 0 16px rgba(255,100,0,0.15); }
    .temp-btn.iced-btn.selected { border-color:rgba(80,160,255,0.6); background:rgba(80,160,255,0.08); color:#66aaff; box-shadow:0 0 16px rgba(80,160,255,0.15); }
    .temp-btn:hover { border-color:var(--border); }
    .temp-unavail { opacity:0.3; cursor:not-allowed; }

    .option-chip { padding:0.45rem 0.9rem; border:1px solid var(--border-dim); border-radius:20px; font-size:0.82rem; cursor:pointer; transition:all 0.2s; color:var(--light-gray); background:transparent; font-family:'DM Sans',sans-serif; }
    .option-chip:hover { border-color:var(--border); color:var(--white); }
    .option-chip.selected { background:var(--red); border-color:var(--red); color:white; box-shadow:0 0 10px rgba(204,0,0,0.3); }
    textarea { width:100%; padding:0.85rem 1rem; border:1px solid var(--border-dim); border-radius:8px; background:#0f0f0f; font-family:'DM Sans',sans-serif; font-size:0.9rem; color:var(--white); outline:none; transition:border-color 0.2s; resize:vertical; min-height:90px; }
    textarea:focus { border-color:var(--red); }
    textarea::placeholder { color:var(--gray); }

    /* Step 3 ‚Äî Delivery */
    input[type=text], select { width:100%; padding:0.85rem 1rem; border:1px solid var(--border-dim); border-radius:8px; background:#0f0f0f; font-family:'DM Sans',sans-serif; font-size:0.9rem; color:var(--white); outline:none; transition:border-color 0.2s; }
    input:focus, select:focus { border-color:var(--red); box-shadow:0 0 0 3px rgba(204,0,0,0.12); }
    input::placeholder { color:var(--gray); }
    select option { background:#1a1a1a; }
    .form-row { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }

    /* Step 4 ‚Äî Review */
    .review-card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:2rem; max-width:520px; }
    .review-header { display:flex; align-items:center; gap:1rem; margin-bottom:1.5rem; padding-bottom:1.5rem; border-bottom:1px solid var(--border-dim); }
    .review-drink-name { font-family:'Bebas Neue',sans-serif; font-size:1.8rem; letter-spacing:0.04em; }
    .review-temp-badge { font-size:0.72rem; padding:0.3rem 0.75rem; border-radius:20px; font-weight:500; }
    .review-temp-badge.hot { background:rgba(255,100,0,0.1); color:#ff9944; border:1px solid rgba(255,100,0,0.25); }
    .review-temp-badge.iced { background:rgba(80,160,255,0.1); color:#66aaff; border:1px solid rgba(80,160,255,0.25); }
    .review-line { display:flex; justify-content:space-between; padding:0.65rem 0; border-bottom:1px solid var(--border-dim); font-size:0.88rem; }
    .review-line:last-of-type { border-bottom:none; }
    .review-key { color:var(--light-gray); }
    .review-val { color:var(--white); font-weight:500; }
    .loyalty-note { background:rgba(204,0,0,0.07); border:1px solid var(--border); border-radius:8px; padding:0.85rem 1rem; margin:1.25rem 0 0; font-size:0.82rem; color:var(--light-gray); display:flex; align-items:center; gap:0.6rem; }
    .loyalty-note span { color:var(--red-bright); font-weight:500; }

    /* Confirmation screen (after save, before Square) */
    .confirm-screen { max-width:520px; }
    .confirm-icon { font-size:3rem; margin-bottom:1rem; display:block; animation:pop 0.4s ease; }
    @keyframes pop { 0%{transform:scale(0)} 80%{transform:scale(1.1)} 100%{transform:scale(1)} }
    .confirm-title { font-family:'Bebas Neue',sans-serif; font-size:2.5rem; letter-spacing:0.04em; margin-bottom:0.5rem; }
    .confirm-sub { color:var(--light-gray); font-size:0.92rem; line-height:1.6; margin-bottom:2rem; }
    .square-btn {
      display:inline-flex; align-items:center; gap:0.75rem;
      background:var(--red); color:white; border:none; border-radius:10px;
      padding:1.1rem 2.25rem; font-family:'DM Sans',sans-serif; font-size:1rem;
      font-weight:500; cursor:pointer; text-decoration:none;
      transition:all 0.2s; text-transform:uppercase; letter-spacing:0.07em;
      box-shadow:0 0 30px rgba(204,0,0,0.35);
      animation:pulse-btn 2s ease-in-out infinite;
    }
    .square-btn:hover { background:var(--red-bright); box-shadow:0 0 40px rgba(204,0,0,0.6); transform:translateY(-2px); }
    @keyframes pulse-btn { 0%,100%{box-shadow:0 0 25px rgba(204,0,0,0.3)} 50%{box-shadow:0 0 45px rgba(204,0,0,0.6)} }
    .square-btn-icon { font-size:1.2rem; }
    .no-link-note { background:rgba(255,255,255,0.04); border:1px solid var(--border-dim); border-radius:8px; padding:1rem; font-size:0.85rem; color:var(--gray); margin-top:1rem; }
    .skip-link { display:block; margin-top:1.25rem; font-size:0.82rem; color:var(--gray); text-decoration:none; transition:color 0.2s; }
    .skip-link:hover { color:var(--light-gray); }

    /* Buttons */
    .btn-primary { background:var(--red); color:white; border:none; border-radius:8px; padding:0.9rem 2rem; font-family:'DM Sans',sans-serif; font-size:0.9rem; font-weight:500; cursor:pointer; transition:all 0.2s; text-transform:uppercase; letter-spacing:0.06em; }
    .btn-primary:hover { background:var(--red-bright); box-shadow:0 0 20px rgba(204,0,0,0.4); transform:translateY(-1px); }
    .btn-primary:disabled { opacity:0.4; cursor:not-allowed; transform:none; box-shadow:none; }
    .btn-ghost { background:transparent; color:var(--light-gray); border:1px solid var(--border-dim); border-radius:8px; padding:0.9rem 2rem; font-family:'DM Sans',sans-serif; font-size:0.9rem; cursor:pointer; transition:all 0.2s; text-transform:uppercase; letter-spacing:0.06em; }
    .btn-ghost:hover { border-color:var(--border); color:var(--white); }
    .btn-row { display:flex; gap:1rem; margin-top:2rem; flex-wrap:wrap; }

    @media (max-width:900px) { .layout{grid-template-columns:1fr} .sidebar{display:none} .main{padding:1.5rem} .customize-grid{grid-template-columns:1fr} .temp-selector{flex-direction:column} }
  </style>
</head>
<body>
<div class="layout">
  <aside class="sidebar">
    <div class="sidebar-logo"><img src="../logo.png" alt="The Birdhouse" /></div>
    <div class="user-card">
      <div class="user-name" id="user-display-name">Loading...</div>
      <div class="user-points" id="user-points-badge">0 points</div>
    </div>
    <nav>
      <a class="nav-item" href="dashboard.html">üìä Overview</a>
      <a class="nav-item active" href="order.html">‚òï Place an Order</a>
      <a class="nav-item" href="dashboard.html">üìã Order History</a>
      <a class="nav-item" href="dashboard.html">üì¶ My Subscription</a>
      <a class="nav-item" href="dashboard.html">‚≠ê Loyalty Rewards</a>
    </nav>
    <button class="signout-btn" onclick="signOut()">‚Üê Sign Out</button>
  </aside>

  <main class="main">
    <div class="page-eyebrow">Customer Portal</div>
    <h1 class="page-title">Place an Order</h1>
    <p class="page-sub">Choose your drink, customize it, and we'll deliver it to your room.</p>

    <!-- Step indicator -->
    <div class="steps">
      <div class="step active" id="step-ind-1"><div class="step-num">1</div> Choose Drink</div>
      <div class="step-line"></div>
      <div class="step" id="step-ind-2"><div class="step-num">2</div> Customize</div>
      <div class="step-line"></div>
      <div class="step" id="step-ind-3"><div class="step-num">3</div> Delivery</div>
      <div class="step-line"></div>
      <div class="step" id="step-ind-4"><div class="step-num">4</div> Review</div>
      <div class="step-line"></div>
      <div class="step" id="step-ind-5"><div class="step-num">5</div> Pay</div>
    </div>

    <!-- Step 1: Choose drink -->
    <div class="step-panel active" id="panel-1">
      <div id="menu-container"><div class="no-menu">Loading menu...</div></div>
      <div class="btn-row">
        <button class="btn-primary" id="btn-next-1" onclick="goToStep(2)" disabled>Next: Customize ‚Üí</button>
      </div>
    </div>

    <!-- Step 2: Customize -->
    <div class="step-panel" id="panel-2">
      <div class="form-group">
        <label>Hot or Iced?</label>
        <div class="temp-selector">
          <button class="temp-btn hot-btn" id="btn-hot" onclick="selectTemp('hot')">
            <span class="temp-icon">‚òï</span>
            Hot
            <div class="temp-size">12 oz</div>
          </button>
          <button class="temp-btn iced-btn" id="btn-iced" onclick="selectTemp('iced')">
            <span class="temp-icon">üßä</span>
            Iced
            <div class="temp-size">16 oz</div>
          </button>
        </div>
      </div>
      <div class="customize-grid">
        <div>
          <div class="form-group">
            <label>Milk Type</label>
            <div class="option-row" id="milk-options"></div>
          </div>
          <div class="form-group">
            <label>Add a Syrup <span style="color:var(--gray);font-weight:300">(optional)</span></label>
            <div class="option-row" id="syrup-options"></div>
          </div>
        </div>
        <div>
          <div class="form-group">
            <label>Special Instructions <span style="color:var(--gray);font-weight:300">(optional)</span></label>
            <textarea id="special-instructions" placeholder="Extra shot, less sweet, extra hot..."></textarea>
          </div>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn-ghost" onclick="goToStep(1)">‚Üê Back</button>
        <button class="btn-primary" id="btn-next-2" onclick="goToStep(3)" disabled>Next: Delivery ‚Üí</button>
      </div>
    </div>

    <!-- Step 3: Delivery -->
    <div class="step-panel" id="panel-3">
      <div style="max-width:500px">
        <div class="form-group">
          <label>Room / Location</label>
          <input type="text" id="delivery-room" placeholder="e.g. Room 204, Library, Gym" />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Delivery Day</label>
            <select id="delivery-day">
              <option value="Today">Today</option>
              <option value="Monday">Monday</option>
              <option value="Tuesday">Tuesday</option>
              <option value="Wednesday">Wednesday</option>
              <option value="Thursday">Thursday</option>
              <option value="Friday">Friday</option>
            </select>
          </div>
          <div class="form-group">
            <label>Preferred Time</label>
            <select id="delivery-time"><option value="">Select a time...</option></select>
          </div>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn-ghost" onclick="goToStep(2)">‚Üê Back</button>
        <button class="btn-primary" onclick="goToStep(4)">Review Order ‚Üí</button>
      </div>
    </div>

    <!-- Step 4: Review -->
    <div class="step-panel" id="panel-4">
      <div class="review-card">
        <div class="review-header">
          <div>
            <div style="font-size:0.65rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--red);margin-bottom:0.3rem">Your Order</div>
            <div class="review-drink-name" id="review-drink-name">‚Äî</div>
          </div>
          <div class="review-temp-badge" id="review-temp-badge">‚Äî</div>
        </div>
        <div id="review-lines"></div>
        <div class="loyalty-note">‚≠ê You'll earn <span>+1 loyalty point</span> for this order!</div>
      </div>
      <div class="btn-row">
        <button class="btn-ghost" onclick="goToStep(3)">‚Üê Back</button>
        <button class="btn-primary" id="submit-btn" onclick="submitOrder()">Save Order & Continue ‚Üí</button>
      </div>
    </div>

    <!-- Step 5: Confirmation + Square redirect -->
    <div class="step-panel" id="panel-5">
      <div class="confirm-screen">
        <span class="confirm-icon">‚úÖ</span>
        <div class="confirm-title">Order Saved!</div>
        <p class="confirm-sub">Your order details have been sent to our team. Now complete your payment through Square to confirm your order.</p>

        <div id="square-btn-wrap"></div>
        <a class="skip-link" href="dashboard.html">‚Üê Back to dashboard (pay later / cash)</a>
      </div>
    </div>

  </main>
</div>

<script>
  const sb = supabase.createClient('https://ljukrhneikqbabcmcpet.supabase.co','sb_publishable_lWdxpZUHbQHiz04wthAC2g_X4ToxDCn');
  let currentUser = null;
  let menuItems = [];
  let selectedItem = null;
  let selectedTemp = null; // 'hot' or 'iced'
  let selectedMilk = null;
  let selectedSyrup = 'None';

  async function init() {
    const {data:{session}} = await sb.auth.getSession();
    if(!session){window.location.href='index.html';return;}
    currentUser = session.user;
    const meta = currentUser.user_metadata;
    document.getElementById('user-display-name').textContent=(meta.first_name||'Eagle')+' '+(meta.last_name||'');
    document.getElementById('user-points-badge').textContent=(meta.loyalty_points||0)+' points';
    if(meta.room) document.getElementById('delivery-room').value=meta.room;
    await loadMenu();
    await loadDeliveryTimes();
  }

  async function loadMenu() {
    const {data,error} = await sb.from('menu_items').select('*').eq('available',true).order('sort_order');
    const container = document.getElementById('menu-container');
    if(error||!data||!data.length){
      container.innerHTML='<div class="no-menu">No menu items yet ‚Äî check back soon!</div>';
      return;
    }
    menuItems = data;
    const cats = [...new Set(data.map(i=>i.category))];
    container.innerHTML = cats.map(cat=>`
      <div class="category-label">${cat}</div>
      <div class="menu-grid">
        ${data.filter(i=>i.category===cat).map(item=>`
          <div class="menu-card" id="card-${item.id}" onclick="selectItem('${item.id}')">
            <div class="menu-card-check">‚úì</div>
            <div class="menu-card-name">${item.name}</div>
            <div class="menu-card-desc">${item.description||''}</div>
            <div class="menu-card-tags">
              ${item.is_hot!==false?'<span class="tag hot">‚òï Hot ¬∑ 12oz</span>':''}
              ${item.is_iced===true?'<span class="tag iced">üßä Iced ¬∑ 16oz</span>':''}
            </div>
          </div>`).join('')}
      </div>`).join('');
  }

  function selectItem(id) {
    document.querySelectorAll('.menu-card').forEach(c=>c.classList.remove('selected'));
    document.getElementById('card-'+id).classList.add('selected');
    selectedItem = menuItems.find(i=>i.id===id);
    selectedTemp = null;
    document.getElementById('btn-next-1').disabled = false;
  }

  function loadCustomizationOptions() {
    const milks = selectedItem.available_milks||['Whole Milk','Oat Milk','Almond Milk','2% Milk'];
    const syrups = selectedItem.available_syrups||['Vanilla','Caramel','Hazelnut','Sugar Free Vanilla'];

    document.getElementById('milk-options').innerHTML = milks.map((m,i)=>
      `<button class="option-chip ${i===0?'selected':''}" onclick="selectChip(this,'milk','${m}')">${m}</button>`
    ).join('');
    selectedMilk = milks[0];

    document.getElementById('syrup-options').innerHTML =
      `<button class="option-chip selected" onclick="selectChip(this,'syrup','None')">None</button>` +
      syrups.map(s=>`<button class="option-chip" onclick="selectChip(this,'syrup','${s}')">${s}</button>`).join('');
    selectedSyrup = 'None';

    // Configure temp buttons based on what item supports
    const hotBtn = document.getElementById('btn-hot');
    const icedBtn = document.getElementById('btn-iced');
    const hasHot = selectedItem.is_hot !== false;
    const hasIced = selectedItem.is_iced === true;

    hotBtn.classList.remove('selected','temp-unavail');
    icedBtn.classList.remove('selected','temp-unavail');
    if(!hasHot) hotBtn.classList.add('temp-unavail');
    if(!hasIced) icedBtn.classList.add('temp-unavail');

    // Auto-select if only one option
    if(hasHot && !hasIced) selectTemp('hot');
    else if(hasIced && !hasHot) selectTemp('iced');

    checkTempSelected();
  }

  function selectTemp(type) {
    const item = selectedItem;
    if(type==='hot' && item.is_hot===false) return;
    if(type==='iced' && item.is_iced!==true) return;
    selectedTemp = type;
    document.getElementById('btn-hot').classList.toggle('selected', type==='hot');
    document.getElementById('btn-iced').classList.toggle('selected', type==='iced');
    checkTempSelected();
  }

  function checkTempSelected() {
    document.getElementById('btn-next-2').disabled = !selectedTemp;
  }

  function selectChip(el, type, value) {
    el.closest('.option-row').querySelectorAll('.option-chip').forEach(c=>c.classList.remove('selected'));
    el.classList.add('selected');
    if(type==='milk') selectedMilk=value;
    if(type==='syrup') selectedSyrup=value;
  }

  async function loadDeliveryTimes() {
    const {data} = await sb.from('store_config').select('value').eq('key','delivery_times').single();
    const times = data?.value||['7:30 AM','8:00 AM','9:00 AM','10:00 AM','11:00 AM','12:00 PM'];
    const sel = document.getElementById('delivery-time');
    times.forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t;sel.appendChild(o);});
  }

  function buildReview() {
    const room = document.getElementById('delivery-room').value;
    const time = document.getElementById('delivery-time').value;
    const day = document.getElementById('delivery-day').value;
    const notes = document.getElementById('special-instructions').value;

    document.getElementById('review-drink-name').textContent = selectedItem.name;
    const badge = document.getElementById('review-temp-badge');
    badge.textContent = selectedTemp==='hot'?'‚òï Hot ¬∑ 12oz':'üßä Iced ¬∑ 16oz';
    badge.className = 'review-temp-badge '+(selectedTemp==='hot'?'hot':'iced');

    const lines = [
      {k:'Milk', v:selectedMilk},
      {k:'Syrup', v:selectedSyrup||'None'},
      {k:'Delivery', v:`${day} at ${time||'‚Äî'}`},
      {k:'Room', v:room||'‚Äî'},
    ];
    if(notes) lines.push({k:'Instructions', v:notes});
    document.getElementById('review-lines').innerHTML = lines.map(l=>
      `<div class="review-line"><span class="review-key">${l.k}</span><span class="review-val">${l.v}</span></div>`
    ).join('');
  }

  function goToStep(step) {
    if(step===3){
      const room=document.getElementById('delivery-room').value.trim();
      // just move ‚Äî validate on submit
    }
    if(step===4){
      const room=document.getElementById('delivery-room').value.trim();
      const time=document.getElementById('delivery-time').value;
      if(!room){alert('Please enter your room or delivery location.');return;}
      if(!time){alert('Please select a delivery time.');return;}
      buildReview();
    }
    if(step===2) loadCustomizationOptions();

    document.querySelectorAll('.step-panel').forEach(p=>p.classList.remove('active'));
    document.getElementById('panel-'+step).classList.add('active');
    for(let i=1;i<=5;i++){
      const ind=document.getElementById('step-ind-'+i);
      if(ind) ind.className='step'+(i===step?' active':i<step?' done':'');
    }
    window.scrollTo(0,0);
  }

  async function submitOrder() {
    const btn=document.getElementById('submit-btn');
    btn.disabled=true; btn.textContent='Saving...';
    const room=document.getElementById('delivery-room').value;
    const time=document.getElementById('delivery-time').value;
    const day=document.getElementById('delivery-day').value;
    const notes=document.getElementById('special-instructions').value;
    const meta=currentUser.user_metadata;

    const {error} = await sb.from('orders').insert({
      user_id: currentUser.id,
      customer_name: (meta.first_name||'')+' '+(meta.last_name||''),
      drink_name: selectedItem.name,
      room, size: selectedTemp==='hot'?'Hot 12oz':'Iced 16oz',
      milk: selectedMilk, syrup: selectedSyrup,
      delivery_time: time, delivery_day: day,
      special_instructions: notes, points_earned: 1, status: 'pending'
    });

    if(error){alert('Error saving order: '+error.message);btn.disabled=false;btn.textContent='Save Order & Continue ‚Üí';return;}

    // Award loyalty point
    await sb.auth.updateUser({data:{loyalty_points:(meta.loyalty_points||0)+1}});

    // Determine correct Square link
    const squareLink = selectedTemp==='hot' ? selectedItem.square_link_hot : selectedItem.square_link_iced;

    // Show confirmation with Square button
    document.querySelectorAll('.step-panel').forEach(p=>p.classList.remove('active'));
    document.getElementById('panel-5').classList.add('active');
    for(let i=1;i<=5;i++){
      const ind=document.getElementById('step-ind-'+i);
      if(ind) ind.className='step done';
    }

    const wrap=document.getElementById('square-btn-wrap');
    if(squareLink){
      wrap.innerHTML=`<a class="square-btn" href="${squareLink}" target="_blank"><span class="square-btn-icon">üí≥</span> Complete Payment in Square</a>`;
    } else {
      wrap.innerHTML=`<div class="no-link-note">‚ö†Ô∏è No payment link set up for this item yet. Please pay cash or contact staff to complete your order.</div>`;
    }

    window.scrollTo(0,0);
  }

  async function signOut(){await sb.auth.signOut();window.location.href='index.html';}
  init();
</script>
</body>
</html>
